# Docker compose file to run Forest and Lotus API tests.
version: "3.8"

services:
  init:
    build:
      context: ../../../.
      dockerfile: ${FOREST_DOCKERFILE_OVERRIDE:-Dockerfile}
    volumes:
      - node-data:/data
      - filecoin-proofs:${FIL_PROOFS_PARAMETER_CACHE}
    networks:
      - snapshot-parity-tests
    environment:
      - FIL_PROOFS_PARAMETER_CACHE=${FIL_PROOFS_PARAMETER_CACHE}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -euxo pipefail
        # fetch parameter files
        forest-tool fetch-params --keys
        # if there are some files in the data directory, then we don't need to fetch the snapshot
        if [ "$$(ls -A /data/*.car.zst)" ]; then
          echo "Snapshot already fetched"
        else
          forest-tool snapshot fetch --chain calibnet -d /data
        fi
        mkdir -p /data/exported
  forest:
    depends_on:
      init:
        condition: service_completed_successfully
    build:
      context: ../../../.
      dockerfile: ${FOREST_DOCKERFILE_OVERRIDE:-Dockerfile}
    volumes:
      - node-data:/data
      - filecoin-proofs:${FIL_PROOFS_PARAMETER_CACHE}
    networks:
      - snapshot-parity-tests
    environment:
      - FIL_PROOFS_PARAMETER_CACHE=${FIL_PROOFS_PARAMETER_CACHE}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -euxo pipefail
        forest --chain ${CHAIN} --encrypt-keystore false --no-gc \
          --import-snapshot $(ls /data/*.car.zst | tail -n 1) \
          --import-mode=symlink &
        sleep 15
        forest-cli sync wait
        forest-cli snapshot export -t=$(ls /data/*.car.zst | tail -n 1 | grep -Eo '[0-9]+' | tail -n 1) -d=${EXPORT_EPOCHS} -o /data/exported/forest.car.zst
        kill -KILL $!
        forest-tool db destroy --chain ${CHAIN}
        pushd /data/exported
        apt-get update
        apt-get install -y zstd
        zstd -d --rm forest.car.zst
        sha256sum forest.car | cut -d" " -f 1 > forest.car.sha256sum
        cat forest.car.sha256sum
        rm forest.car
        popd
  lotus:
    depends_on:
      init:
        condition: service_completed_successfully
      # Run snapshot sequentially due to limited RAM on GH hosted runners
      forest:
        condition: service_completed_successfully
      # To force the daemons run sequentially on CI to get rid of OOM
      # forest:
      #   condition: service_completed_successfully
    image: ${LOTUS_IMAGE}
    volumes:
      - node-data:/data
      - lotus-data:/var/lib/lotus
      - filecoin-proofs:${FIL_PROOFS_PARAMETER_CACHE}
    networks:
      - snapshot-parity-tests
    environment:
      - FIL_PROOFS_PARAMETER_CACHE=${FIL_PROOFS_PARAMETER_CACHE}
      - LOTUS_API_LISTENADDRESS=/ip4/0.0.0.0/tcp/${LOTUS_RPC_PORT}/http
      - LOTUS_EVENTS_ENABLEACTOREVENTSAPI=0
      - LOTUS_FEVM_ENABLEETHRPC=0
      - LOTUS_CHAININDEXER_ENABLEINDEXER=0
      - LOTUS_CHAINSTORE_ENABLESPLITSTORE=false
      - LOTUS_SYNC_BOOTSTRAP_PEERS=1
      - FULLNODE_API_INFO=/dns/lotus/tcp/${LOTUS_RPC_PORT}/http
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -euxo pipefail
        lotus daemon --remove-existing-chain --import-snapshot $(ls /data/*.car.zst | tail -n 1) &
        lotus wait-api --timeout 20m
        lotus sync wait
        lotus chain export --tipset @$(ls /data/*.car.zst | tail -n 1 | grep -Eo '[0-9]+' | tail -n 1) --recent-stateroots ${EXPORT_EPOCHS} --skip-old-msgs /data/exported/lotus.car
        kill -KILL $!
        pushd /data/exported
        sha256sum lotus.car | cut -d" " -f 1 > lotus.car.sha256sum
        cat lotus.car.sha256sum
        rm lotus.car
        popd
  compare:
    depends_on:
      forest:
        condition: service_completed_successfully
      lotus:
        condition: service_completed_successfully
    build:
      context: ../../../.
      dockerfile: ${FOREST_DOCKERFILE_OVERRIDE:-Dockerfile}
    volumes:
      - node-data:/data
    networks:
      - snapshot-parity-tests
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -euxo pipefail
        pushd /data/exported
        diff forest.car.sha256sum lotus.car.sha256sum
        popd
  post-setup:
    depends_on:
      compare:
        condition: service_completed_successfully
    image: busybox
    networks:
      - snapshot-parity-tests
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -euxo pipefail
        echo "Success"

volumes:
  filecoin-proofs:
  node-data:
  # mount this to /var/lib/lotus to avoid creating random volumes
  lotus-data:

networks:
  snapshot-parity-tests:
